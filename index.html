<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emberlux CRM • Admin Panel</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0b08;
            --card: #17130f;
            --text: #e8e0d5;
            --text-muted: #a0896e;
            --accent: #d4a373;
            --accent-dark: #b5895b;
            --border: rgba(212,163,115,0.15);
            --glow: rgba(212,163,115,0.08);
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        h1, h2, h3 { font-family: 'Playfair Display', serif; font-weight: 600; }
        .container { max-width: 1280px; margin: 0 auto; padding: 1.5rem; }
        header {
            padding: 2rem 0 1.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        header h1 {
            font-size: 2.5rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }
        .tabs {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            margin: 2rem 0;
            flex-wrap: wrap;
        }
        .tab {
            padding: 0.9rem 2.2rem;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 50px;
            color: var(--text-muted);
            font-weight: 500;
            letter-spacing: 0.5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .tab.active,
        .tab:hover {
            background: var(--accent);
            color: #0d0b08;
            box-shadow: 0 0 25px var(--glow);
        }
        .section { display: none; }
        .section.active { display: block; }
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 1.8rem;
            margin-bottom: 2rem;
            backdrop-filter: blur(6px);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2.5rem;
        }
        .stat-card {
            text-align: center;
            padding: 1.5rem;
        }
        .stat-number {
            font-size: 2.4rem;
            font-weight: 700;
            color: var(--accent);
            margin: 0.5rem 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 1.1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th { color: var(--accent); font-weight: 600; }
        .btn {
            background: var(--accent);
            color: #0d0b08;
            border: none;
            padding: 0.8rem 1.6rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.25s;
        }
        .btn:hover { background: var(--accent-dark); transform: translateY(-2px); }
        .btn.clear-btn {
            background: #444;
            color: white;
        }
        .form-input, textarea {
            background: rgba(255,255,255,0.04);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 0.9rem 1.2rem;
            border-radius: 8px;
            width: 100%;
            margin-bottom: 1.3rem;
            font-size: 1rem;
        }
        .form-input:focus, textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--glow);
            outline: none;
        }
        .images-gallery img {
            max-width: 140px;
            border-radius: 8px;
            margin: 0.5rem;
            border: 1px solid var(--border);
        }
        #total-products {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--accent);
            color: #0d0b08;
            padding: 10px 18px;
            border-radius: 50px;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .catalog-search-row {
            display: fix;
            gap: 10px;
            flex-wrap: wrap;
            margin: 1.5rem 0;
        }
        .catalog-search-row input {
            flex: 1;
            min-width: 220px;
        }
        @media (max-width: 768px) {
            .tabs { gap: 1rem; }
            .tab { padding: 0.7rem 1.4rem; font-size: 0.95rem; }
            .catalog-search-row { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>Emberlux CRM</h1>
            <p style="opacity:0.7; font-size:1.1rem;">Admin Panel • Product Management</p>
        </header>

        <div class="tabs">
            <div class="tab active" id="tab-home">Home / Overview</div>
            <div class="tab" id="tab-catalog">Product Catalog</div>
            <div class="tab" id="tab-add">Add Product</div>
        </div>

        <!-- Home / Overview -->
        <div id="home-section" class="section active">
            <div class="stats-grid">
                <div class="card stat-card">
                    <div style="font-size:1.1rem; color:var(--text-muted);">Total Products</div>
                    <div class="stat-number" id="total-count">0</div>
                </div>
                <div class="card stat-card">
                    <div style="font-size:1.1rem; color:var(--text-muted);">Recent Additions</div>
                    <div class="stat-number" id="recent-count">—</div>
                </div>
                <div class="card stat-card">
                    <div style="font-size:1.1rem; color:var(--text-muted);">Avg. Price</div>
                    <div class="stat-number" id="avg-price">—</div>
                </div>
            </div>

            <div class="card">
                <h2>Recent Products</h2>
                <div id="recent-products" style="margin-top:1.5rem;">
                    <p style="text-align:center; opacity:0.7;">Loading products...</p>
                </div>
            </div>
        </div>

        <!-- Product Catalog -->
        <div id="catalog-section" class="section">
            <div class="card">
                <h2>Product Catalog</h2>

                <div class="catalog-search-row">
                    <input type="text" id="catalog-search-input" class="form-input" placeholder="Search by name or ID...">
                    <button class="btn" id="catalog-search-btn">Search</button>
                    <button class="btn clear-btn" id="catalog-clear-btn">Clear</button>
                </div>

                <div id="product-list"></div>

                <div style="text-align:center; margin-top:2rem;">
                    <button class="btn" id="prev-page">Prev</button>
                    <span id="page-info" style="margin:0 1.5rem; color:var(--text-muted);"></span>
                    <button class="btn" id="next-page">Next</button>
                </div>
            </div>
        </div>

        <!-- Add Product -->
        <div id="add-section" class="section">
            <div class="card" style="max-width:760px; margin:0 auto;">
                <h2>Add New Product</h2>
                <form id="add-product-form" style="margin-top:2rem;">
                    <input type="text" name="name" class="form-input" placeholder="Product Name *" required>
                    <input type="text" name="color" class="form-input" placeholder="Color / Vessel Theme">
                    <input type="text" name="currency" value="INR" readonly class="form-input">
                    <input type="number" name="price" class="form-input" placeholder="Price (INR) *" required>
                    <textarea name="description" class="form-input" placeholder="Full description, notes, story..." rows="6" required></textarea>
                    <input type="file" name="images" multiple class="form-input" required>
                    <button type="submit" class="btn" style="width:100%; padding:1.2rem; font-size:1.1rem;">Create Product</button>
                </form>
                <div id="add-result" style="margin-top:1.8rem; font-weight:600; text-align:center; font-size:1.1rem;"></div>
            </div>
        </div>

        <!-- Product Detail -->
        <div id="detail-section" class="section">
            <div class="card">
                <h2>Product Detail</h2>
                <div style="margin:1.8rem 0; max-width:500px;">
                    <input type="text" id="product-id-input" class="form-input" placeholder="Enter Product ID to view">
                    <button class="btn" onclick="fetchProductDetail()" style="margin-top:1rem; width:100%;">Load Details</button>
                </div>
                <div id="product-detail-content"></div>
            </div>
        </div>
    </div>

    <div id="total-products"></div>

<script>
// ──────────────────────────────────────────────
const SECRET_KEY = "w4Z7t+X1xk6uG4q8HVJFcE3XxXH8mH7AwVSTKX2QZog=";
const IV = "bWlndHR5aXYxMjM=";

async function importKey() {
    const keyBytes = base64ToArrayBuffer(SECRET_KEY);
    return crypto.subtle.importKey("raw", keyBytes, "AES-GCM", false, ["decrypt"]);
}

function base64ToArrayBuffer(base64) {
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return bytes.buffer;
}

async function decryptData(encryptedBase64) {
    const key = await importKey();
    const iv = base64ToArrayBuffer(IV);
    const encryptedArrayBuffer = base64ToArrayBuffer(encryptedBase64);
    const decryptedBuffer = await crypto.subtle.decrypt({name:"AES-GCM",iv}, key, encryptedArrayBuffer);
    return JSON.parse(new TextDecoder().decode(decryptedBuffer));
}

let allProducts = [];
let currentPage = 1;
const pageSize = 10;

// Tab switching
const tabs = document.querySelectorAll('.tab');
const sections = document.querySelectorAll('.section');

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        sections.forEach(s => s.classList.remove('active'));
        let sectionId;
        if (tab.id === 'tab-home') sectionId = 'home-section';
        else if (tab.id === 'tab-catalog') sectionId = 'catalog-section';
        else if (tab.id === 'tab-add') sectionId = 'add-section';
        document.getElementById(sectionId).classList.add('active');
        if (tab.id === 'tab-home' || tab.id === 'tab-catalog') {
            fetchAndRenderProducts();
        }
    });
});

// ─── Fetch & Render Products ───
async function fetchAndRenderProducts() {
    if (allProducts.length > 0) {
        renderOverview();
        renderCatalog();
        return;
    }

    const loadingDiv = document.getElementById('recent-products');
    loadingDiv.innerHTML = '<p style="text-align:center; opacity:0.7;">Loading products...</p>';

    try {
        const res = await fetch("https://emberlux-backend.onrender.com/api/v1/products/all-product");
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const encrypted = await res.text();
        allProducts = await decryptData(encrypted);
        allProducts.reverse();
        renderOverview();
        renderCatalog();
    } catch (e) {
        console.error(e);
        loadingDiv.innerHTML = `<p style="color:#e07a5f; text-align:center; padding:2rem;">Failed to load: ${e.message}</p>`;
    }
}

function renderOverview() {
    document.getElementById('total-count').textContent = allProducts.length;
    document.getElementById('recent-count').textContent = Math.min(6, allProducts.length);

    const totalPrice = allProducts.reduce((sum, p) => sum + (Number(p.price) || 0), 0);
    const avg = allProducts.length ? '₹' + (totalPrice / allProducts.length).toFixed(0) : '—';
    document.getElementById('avg-price').textContent = avg;

    const container = document.getElementById('recent-products');
    container.innerHTML = allProducts.length === 0 
        ? '<p style="text-align:center; opacity:0.7;">No products available</p>'
        : '';

    allProducts.slice(0, 6).forEach(p => {
        const card = document.createElement('div');
        card.style.cssText = 'display:flex; align-items:center; gap:1.2rem; margin-bottom:1.2rem; padding:1rem; background:rgba(255,255,255,0.03); border:1px solid var(--border); border-radius:10px;';
        card.innerHTML = `
            <img src="${p.images?.[0] || 'https://via.placeholder.com/90?text=Emberlux'}" alt="" style="width:90px; height:90px; object-fit:cover; border-radius:8px; background:#111;">
            <div style="flex:1;">
                <div style="font-weight:600; font-size:1.1rem;">${p.name || 'Unnamed'}</div>
                <div style="color:var(--accent); margin:0.3rem 0;">${p.currency || 'INR'} ${p.price || '—'}</div>
                <div style="color:#c9a67c; font-size:0.9rem; cursor:pointer;" onclick="viewProduct('${p.id}')">View Detail →</div>
            </div>
        `;
        container.appendChild(card);
    });
}

// ─── Catalog Render + Search Filter ───
function renderCatalog(filteredProducts = allProducts) {
    const container = document.getElementById('product-list');
    container.innerHTML = '';

    if (filteredProducts.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:3rem 1rem; color:#e07a5f;">No matching products found</p>';
        return;
    }

    const start = (currentPage - 1) * pageSize;
    const end = Math.min(start + pageSize, filteredProducts.length);
    const pageData = filteredProducts.slice(start, end);

    document.getElementById('total-products').innerText = `Showing ${start+1}–${end} of ${filteredProducts.length}`;

    const table = document.createElement('table');
    table.innerHTML = `
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Price</th>
                <th>Image</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector('tbody');

    pageData.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${p.id}</td>
            <td>${p.name || '—'}</td>
            <td style="color:var(--accent);">₹${p.price || '—'}</td>
            <td><img src="${p.images?.[0] || 'https://via.placeholder.com/60'}" alt="" style="width:60px;height:60px;object-fit:cover;border-radius:6px;"></td>
            <td><button class="btn" style="padding:0.6rem 1rem;font-size:0.9rem;" onclick="viewProduct('${p.id}')">View</button></td>
        `;
        tbody.appendChild(tr);
    });

    container.appendChild(table);

    document.getElementById('page-info').innerText = `Page ${currentPage} of ${Math.ceil(filteredProducts.length / pageSize)}`;
    document.getElementById('prev-page').disabled = currentPage === 1;
    document.getElementById('next-page').disabled = currentPage * pageSize >= filteredProducts.length;
}

// Pagination buttons
document.getElementById('prev-page').addEventListener('click', () => {
    if (currentPage > 1) {
        currentPage--;
        renderCatalog();
    }
});

document.getElementById('next-page').addEventListener('click', () => {
    if (currentPage * pageSize < allProducts.length) {
        currentPage++;
        renderCatalog();
    }
});

// ─── Catalog Search Logic ───
function performCatalogSearch() {
    const term = document.getElementById('catalog-search-input').value.trim().toLowerCase();

    if (!term) {
        currentPage = 1;
        renderCatalog(allProducts);
        return;
    }

    const filtered = allProducts.filter(p => 
        (p.id + '').toLowerCase().includes(term) || 
        (p.name || '').toLowerCase().includes(term)
    );

    currentPage = 1;
    renderCatalog(filtered);
}

document.getElementById('catalog-search-btn')?.addEventListener('click', performCatalogSearch);

document.getElementById('catalog-search-input')?.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
        e.preventDefault();
        performCatalogSearch();
    }
});

document.getElementById('catalog-clear-btn')?.addEventListener('click', () => {
    document.getElementById('catalog-search-input').value = '';
    performCatalogSearch();
});

// ─── Other functions remain unchanged ───
async function viewProduct(id) {
    document.getElementById('product-id-input').value = id;
    tabs.forEach(t => t.classList.remove('active'));
    sections.forEach(s => s.classList.remove('active'));
    document.getElementById('detail-section').classList.add('active');
    await fetchProductDetail();
}

async function fetchProductDetail() {
    const id = document.getElementById('product-id-input').value.trim();
    if (!id) {
        document.getElementById('product-detail-content').innerHTML = '<p style="text-align:center; opacity:0.7;">Enter Product ID</p>';
        return;
    }
    try {
        const res = await fetch(`https://emberlux-backend.onrender.com/api/v1/products/${id}`);
        if (!res.ok) throw new Error(`Status ${res.status}`);
        const encrypted = await res.text();
        const p = await decryptData(encrypted);
        const imagesHtml = (p.images || []).map(img => `<img src="${img}" alt="${p.name || 'Product image'}">`).join('');
        document.getElementById('product-detail-content').innerHTML = `
            <table style="margin-top:1.5rem;">
                <tr><th>ID</th><td>${p.id}</td></tr>
                <tr><th>Name</th><td>${p.name}</td></tr>
                <tr><th>Color</th><td>${p.color || '—'}</td></tr>
                <tr><th>Price</th><td style="color:var(--accent);">₹${p.price}</td></tr>
                <tr><th>Description</th><td>${p.description || 'No description'}</td></tr>
                <tr><th>Images</th><td><div class="images-gallery">${imagesHtml || 'No images'}</div></td></tr>
            </table>
        `;
    } catch (e) {
        console.error(e);
        document.getElementById('product-detail-content').innerHTML = 
            `<p style="color:#e07a5f; text-align:center; margin-top:2rem;">Failed: ${e.message}</p>`;
    }
}

document.getElementById('add-product-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = e.target.querySelector('button');
    btn.disabled = true;
    btn.textContent = 'Creating...';
    try {
        const formData = new FormData(e.target);
        const res = await fetch("https://emberlux-backend.onrender.com/api/v1/products/add", {
            method: "POST",
            body: formData
        });
        if (!res.ok) throw new Error("Add failed");
        const data = await res.json();
        document.getElementById('add-result').innerHTML = 
            `✅ Product <strong>${data.name || 'New'}</strong> created!`;
        document.getElementById('add-result').style.color = 'var(--accent)';
        e.target.reset();
        allProducts = [];
        fetchAndRenderProducts();
    } catch (err) {
        console.error(err);
        document.getElementById('add-result').innerHTML = '❌ Failed to add product';
        document.getElementById('add-result').style.color = '#e07a5f';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Product';
    }
});

// Initial load
fetchAndRenderProducts();
</script>
</body>
</html>